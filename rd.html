<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recherche & D√©veloppement</title>

  <!-- Lib pour lire et g√©n√©rer fichiers Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Bootstrap pour le style -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    #fileInput { max-width: 300px; }
    .appareil-table { margin-bottom: 2rem; }
    #loadingMsg { display: none; font-style: italic; color: #666; }
  </style>
</head>

<body class="p-4 bg-light">
  <!-- Barre de navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">üìä C√¢bles Viewer</a>
      <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" href="index.html">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="cable.html">Rechercher C√¢ble</a></li>
          <li class="nav-item"><a class="nav-link" href="appareil.html">Rechercher Appareil</a></li>
          <li class="nav-item"><a class="nav-link" href="generate.html">G√©n√©rer JSON</a></li>
          <li class="nav-item"><a class="nav-link active" href="rd.html">R&D</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>Recherche & D√©veloppement</h1>
    <p>Vous pouvez s√©parer les noms d'appareils par espace, retour √† la ligne, virgule ou point-virgule. Ou juste coller une colonne Excel.</p>

    <p id="baseIndicator" class="text-muted">Base : inconnue</p>
    <p id="loadingMsg">Chargement du fichier NEC‚Ä¶</p>

    <!-- Zone de chargement fichier NEC -->
    <div class="mb-3">
      <label class="form-label">Charger NEC (.xlsb) :</label>
      <input type="file" id="fileInput" accept=".xlsb" class="form-control">
    </div>

    <!-- Zone de saisie appareils -->
    <div class="mb-3">
      <label class="form-label">Appareils :</label>
      <textarea id="appareilsInput" rows="2" class="form-control"></textarea>
    </div>

    <!-- Boutons -->
    <button class="btn btn-primary mb-3" id="btnSearch">Rechercher</button>
    <button class="btn btn-success mb-3 ms-2" id="btnExportAll">Exporter tout</button>
    <button class="btn btn-warning mb-3 ms-2" id="btnExportNonTires">Exporter non tir√©s</button>
    <button class="btn btn-info mb-3 ms-2" id="btnExportOkAppareils">Exporter appareils OK</button>

    <!-- R√©sultats affich√©s ici -->
    <div id="resultsArea"></div>
  </div>

  <!-- Chargement des pr√©fixes/colonnes (config globale) -->
  <script src="config_changement_navire.js"></script>

  <script>
    // Supprime le pr√©fixe d'un appareil et le met en majuscules (standardisation)
    const strip = s => String(s || "").replace(new RegExp(`^${window.PREFIXES.APPAREIL_PREFIX}`, 'i'), "").toUpperCase();

    let cables = [];         // Tous les c√¢bles, charg√©s via JSON ou fichier
    let globalResults = [];  // R√©sultats de recherche affich√©s (pour export)
    let currentBase = "inconnue"; // Source de donn√©es utilis√©e actuellement

    const COLS = window.COLUMNS;           // Liste des colonnes utiles
    const q = s => document.querySelector(s); // Raccourci
    const updateBase = () => q("#baseIndicator").textContent = `Base : ${currentBase}`;

    // √âv√©nements au chargement de la page
    window.addEventListener("load", () => {
      q("#fileInput").addEventListener("change", handleXLSB);
      q("#btnSearch").addEventListener("click", searchMulti);
      q("#btnExportAll").addEventListener("click", () => exportExcel(false));
      q("#btnExportNonTires").addEventListener("click", () => exportExcel(true));
      q("#btnExportOkAppareils").addEventListener("click", exportOk);
      loadDefaultJSON(); // On charge les JSON si pas de fichier .xlsb
    });

    // Charge les fichiers JSON par colonne (fusionne les donn√©es)
    async function loadDefaultJSON() {
      currentBase = "JSON par d√©faut";
      updateBase();
      const merged = {};
      for (const col of COLS) {
        try {
          const r = await fetch(`json/cables_${col}.json`);
          if (!r.ok) continue;
          const rows = await r.json();
          rows.forEach(item => {
            const id = strip(item.CBL);
            if (!merged[id]) merged[id] = { CBL: id };
            merged[id][col] = item[col];
          });
        } catch (e) {
          console.warn(col, e);
        }
      }
      cables = Object.values(merged);
    }

    // G√®re le fichier .xlsb s√©lectionn√© par l‚Äôutilisateur
    function handleXLSB(e) {
      const f = e.target.files[0];
      if (!f) return;
      q("#loadingMsg").style.display = "block";
      const fr = new FileReader();
      fr.onload = ev => parseXLSB(new Uint8Array(ev.target.result));
      fr.readAsArrayBuffer(f);
    }

    // Parse le fichier .xlsb avec SheetJS
    function parseXLSB(buf) {
      try {
        const wb = XLSX.read(buf, { type: "array" });
        const name = wb.SheetNames.find(n => /cables/i.test(n));
        if (!name) return alert("Feuille 'Cables' absente");
        const raw = XLSX.utils.sheet_to_json(wb.Sheets[name], { defval: "" });
        const merged = {};
        raw.forEach(r => {
          const id = strip(r.CBL);
          if (!merged[id]) merged[id] = { CBL: id };
          COLS.forEach(c => merged[id][c] = r[c]);
        });
        cables = Object.values(merged);
        currentBase = "Fichier NEC";
        updateBase();
        alert(`NEC charg√© : ${cables.length} c√¢bles`);
      } catch (e) {
        alert("Erreur XLSB : " + e.message);
      } finally {
        q("#loadingMsg").style.display = "none";
      }
    }

    // S√©pare les noms d'appareils coll√©s (multi-format)
    function splitInput(txt) {
      return txt.split(/[\s,;]+/).filter(Boolean);
    }

    // Recherche tous les c√¢bles associ√©s aux appareils donn√©s
    function searchMulti() {
      const appareils = splitInput(q("#appareilsInput").value).map(strip);
      if (!appareils.length) return;
      const zone = q("#resultsArea");
      zone.innerHTML = "";
      globalResults = [];

      appareils.forEach(app => {
        // Cherche les c√¢bles connect√©s √† cet appareil (en APA ou APO)
        let list = cables.filter(c => strip(c.APA) === app || strip(c.APO) === app);

        // Si aucun r√©sultat, on tente avec un pr√©fixe type A36-...
        if (!list.length) {
          const pref = `A36-${app}`.toUpperCase();
          list = cables.filter(c => strip(c.APA) === strip(pref) || strip(c.APO) === strip(pref));
        }

        // Affiche dans la page
        zone.innerHTML += buildTable(app, list);

        // Remplit le tableau de r√©sultats (pour export Excel)
        list.forEach(c => {
          const isAPA = strip(c.APA) === app;
          globalResults.push({
            Appareil: app,
            C√¢ble: strip(c.CBL),
            PT_CBL: c.PT_CBL || "",
            GAM: c.GAM || "",
            Statut: c.STT_CBL_BORD || "",
            RespTirage: c.RESP_TIRAGE || "",
            Local: isAPA ? c.LOCAL_APA : c.LOCAL_APO,
            Lot: isAPA ? c.LOT_MTG_APA : c.LOT_MTG_APO
          });
        });
      });
    }

    // Construit la table HTML pour un appareil
    function buildTable(app, list) {
      if (!list.length) return `<h4>${app}</h4><div class="alert alert-warning">Aucun c√¢ble trouv√©.</div>`;
      const any = list[0];
      const loc = strip(any.APA) === app ? any.LOCAL_APA : any.LOCAL_APO;
      const lot = strip(any.APA) === app ? any.LOT_MTG_APA : any.LOT_MTG_APO;

      const rows = list.map(c => `
        <tr>
          <td>${app}</td>
          <td>${strip(c.CBL)}</td>
          <td>${c.PT_CBL || "-"}</td>
          <td>${c.RESP_TIRAGE || "-"}</td>
          <td>${c.GAM || "-"}</td>
          <td>${c.STT_CBL_BORD || "-"}</td>
        </tr>
      `).join("");

      return `
        <div class="appareil-table">
          <h4>${app} ‚Äì ${list.length} c√¢ble(s)<br>
          <small class="text-muted">Lot : ${lot || "-"}/ Local : ${loc || "-"}</small></h4>
          <div class="table-responsive">
            <table class="table table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Appareil</th><th>C√¢ble</th><th>PT_CBL</th><th>Resp. Tirage</th><th>GAM</th><th>Statut</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>`;
    }

    // Exporte les r√©sultats en Excel
    function exportExcel(nonTires) {
      let data = nonTires ? globalResults.filter(r => r.Statut.toUpperCase() !== "T") : globalResults;
      if (!data.length) return alert("Aucune donn√©e !");
      const ws = XLSX.utils.json_to_sheet(data, { header: ["Appareil", "C√¢ble", "PT_CBL", "GAM", "Statut", "RespTirage", "Local", "Lot"] });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Export");
      XLSX.writeFile(wb, nonTires ? "non_tires.xlsx" : "all.xlsx");
    }

    // Exporte les appareils o√π tous les c√¢bles sont OK (statut = T)
    function exportOk() {
      const map = {};
      globalResults.forEach(r => {
        const d = map[r.Appareil] ??= { ok: true, loc: new Set(), lot: new Set() };
        if (r.Statut.toUpperCase() !== "T") d.ok = false;
        if (r.Local) d.loc.add(r.Local);
        if (r.Lot) d.lot.add(r.Lot);
      });

      const arr = Object.entries(map)
        .filter(([, d]) => d.ok)
        .map(([app, d]) => ({
          Appareil: app,
          Local: [...d.loc].join(", "),
          Lot: [...d.lot].join(", "),
          SGDTEL_OK: "OK"
        }));

      if (!arr.length) return alert("Aucun appareil avec tous les c√¢bles T.");
      const ws = XLSX.utils.json_to_sheet(arr, { header: ["Appareil", "Local", "Lot", "SGDTEL_OK"] });
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "OK");
      XLSX.writeFile(wb, "appareils_allT.xlsx");
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
